<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÅúËΩ¶ËÆ∞ÂΩïÊü•ËØ¢</title>
    <!-- ÂºïÂÖ• Element UI Ê†∑Âºè -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
        }

        .status-emoji {
            font-size: 22px;
        }

        .emoji-read {
            color: #2ecc71;
        }

        .emoji-unread {
            color: #e74c3c;
        }

        .el-table th {
            text-align: center;
        }

        .el-table td {
            text-align: center;
        }

        .el-message {
          text-align: center;  /* ‰ΩøÊñáÊú¨Â±Ö‰∏≠ */
          font-size: 32px;      /* ËÆæÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è */
          padding: 15px 15px;   /* ÊéßÂà∂ÈÄöÁü•Ê°ÜÁöÑÂÜÖËæπË∑ùÔºåË∞ÉÊï¥ÈÄöÁü•Ê°ÜÁöÑÂ§ßÂ∞è */
        }

        select, button {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ÈÄâÈ°πÂç° -->
        <el-tabs v-model="activeTab" class="mb-4">
            <!-- Tab 1 - ÂÅúËΩ¶ËÆ∞ÂΩïÊü•ËØ¢ -->
            <el-tab-pane label="Âø´Êï∞ÊçÆ" name="fast">
                <!--
                <el-row class="mb-4" type="flex" direction="column">
                    <el-col :span="24" class="text-right">
                        <el-button class="mb-2" type="primary" size="large" :round="true" @click="fetchData">ÊâãÂä®Âà∑Êñ∞</el-button>
                        <el-select v-model="refreshInterval" @change="handleIntervalChange" placeholder="Ëá™Âä®Âà∑Êñ∞Èó¥Èöî" class="d-inline-block w-auto">
                            <el-option label="2Áßí" :value="2000"></el-option>
                            <el-option label="10Áßí" :value="10000"></el-option>
                            <el-option label="60Áßí" :value="60000"></el-option>
                            <el-option label="‰∏çËá™Âä®Âà∑Êñ∞" :value="0"></el-option>
                        </el-select>
                    </el-col>
                </el-row>
                -->
                <el-table :data="tableDataFast" stripe style="width: 100%" :default-sort="{prop: 'create_time', order: 'descending'}">
                    <el-table-column label="Áä∂ÊÄÅ" width="80">
                        <template slot-scope="scope">
                            <span v-if="scope.row.state === 'Â∑≤ËØª'" class="status-emoji emoji-read">üü†</span>
                            <span v-else class="status-emoji emoji-unread">üü¢</span>
                        </template>
                    </el-table-column>
                    <el-table-column label="ËΩ¶Áâå" prop="plateNum"></el-table-column>
                    <el-table-column label="ËΩ¶Âú∫" prop="parkName"></el-table-column>
                    <el-table-column label="Âú∞ÂùÄ" prop="detailAddress"></el-table-column>
                    <el-table-column label="ÂÖ•Âú∫Êó∂Èó¥" prop="inTime"></el-table-column>
                    <el-table-column label="Êü•ËØ¢Êó∂Èó¥" prop="create_time"></el-table-column>
                    <el-table-column label="ÂÅúÁïôÊó∂Èó¥" prop="residenceTime"></el-table-column>
                    <el-table-column label="ÂØπÊé•/‰∏öÂä°" prop="applicant"></el-table-column>
                    <el-table-column label="Â§áÊ≥®" prop="company"></el-table-column>
                    <el-table-column label="ÊúàÁßüËΩ¶" prop="monthlyRent"></el-table-column>
                    <el-table-column label="Êù•Ê∫ê" prop="webName"></el-table-column>
                    <el-table-column label="Êìç‰Ωú" width="100" header-align="center">
                        <template slot-scope="scope">
                            <el-button size="large" :round="true" type="success" @click="handleCopy(scope.row)">Â§çÂà∂</el-button>
                        </template>
                    </el-table-column>
                    <el-table-column label="Ê†á‰∏∫Êú™ËØª" width="130" header-align="center">
                        <template slot-scope="scope">
                            <el-button size="large" :round="true" type="warning" @click="markAsUnread(scope.row)">Ê†á‰∏∫Êú™ËØª</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>

            <!-- Tab 2 - Á¨¨‰∫å‰∏™ Tab ÂÜÖÂÆπ -->
            <el-tab-pane label="ÊÖ¢Êï∞ÊçÆ" name="slow">
                <!--
                <el-row class="mb-4" type="flex" direction="column">
                    <el-col :span="24" class="text-right">
                        <el-button class="mb-2" type="primary" size="large" :round="true" @click="fetchData">ÊâãÂä®Âà∑Êñ∞</el-button>
                        <el-select v-model="refreshInterval" @change="handleIntervalChange" placeholder="Ëá™Âä®Âà∑Êñ∞Èó¥Èöî" class="d-inline-block w-auto">
                            <el-option label="2Áßí" :value="2000"></el-option>
                            <el-option label="10Áßí" :value="10000"></el-option>
                            <el-option label="60Áßí" :value="60000"></el-option>
                            <el-option label="‰∏çËá™Âä®Âà∑Êñ∞" :value="0"></el-option>
                        </el-select>
                    </el-col>
                </el-row>
                -->
                <el-table :data="tableDataSlow" stripe style="width: 100%" :default-sort="{prop: 'create_time', order: 'descending'}">
                    <el-table-column label="Áä∂ÊÄÅ" width="80">
                        <template slot-scope="scope">
                            <span v-if="scope.row.state === 'Â∑≤ËØª'" class="status-emoji emoji-read">üü†</span>
                            <span v-else class="status-emoji emoji-unread">üü¢</span>
                        </template>
                    </el-table-column>
                    <el-table-column label="ËΩ¶Áâå" prop="plateNum"></el-table-column>
                    <el-table-column label="ËΩ¶Âú∫" prop="parkName"></el-table-column>
                    <el-table-column label="Âú∞ÂùÄ" prop="detailAddress"></el-table-column>
                    <el-table-column label="ÂÖ•Âú∫Êó∂Èó¥" prop="inTime"></el-table-column>
                    <el-table-column label="Êü•ËØ¢Êó∂Èó¥" prop="create_time"></el-table-column>
                    <el-table-column label="ÂÅúÁïôÊó∂Èó¥" prop="residenceTime"></el-table-column>
                    <el-table-column label="ÂØπÊé•/‰∏öÂä°" prop="applicant"></el-table-column>
                    <el-table-column label="Â§áÊ≥®" prop="company"></el-table-column>
                    <el-table-column label="ÊúàÁßüËΩ¶" prop="monthlyRent"></el-table-column>
                    <el-table-column label="Êù•Ê∫ê" prop="webName"></el-table-column>
                    <el-table-column label="Êìç‰Ωú" width="100" header-align="center">
                        <template slot-scope="scope">
                            <el-button size="large" :round="true" type="success" @click="handleCopy(scope.row)">Â§çÂà∂</el-button>
                        </template>
                    </el-table-column>
                    <el-table-column label="Ê†á‰∏∫Êú™ËØª" width="130" header-align="center">
                        <template slot-scope="scope">
                            <el-button size="large" :round="true" type="warning" @click="markAsUnread(scope.row)">Ê†á‰∏∫Êú™ËØª</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>

            <!-- Tab 3 - ÂÅúËΩ¶ËÆ∞ÂΩïÊü•ËØ¢ -->
            <el-tab-pane label="Êü•ËØ¢Êï∞ÊçÆ" name="search_records">
                <el-input
                    v-model="searchFullPlateNum"
                    placeholder="ËæìÂÖ•ÂÆåÊï¥ËΩ¶ÁâåÂè∑Á≤æÁ°ÆÊêúÁ¥¢"
                    @keyup.enter.native="searchRecords"
                    style="width: 300px; margin-bottom: 20px;"
                ></el-input>

                <el-button
                    type="primary"
                    :round="true"
                    @click="searchRecords"
                    style="margin-left: 10px;"
                >ÊêúÁ¥¢</el-button>

                <el-table :data="searchFullPlatesResults" stripe style="width: 100%" :default-sort="{prop: 'create_time', order: 'descending'}">
                    <el-table-column label="ËΩ¶Áâå" prop="plateNum"></el-table-column>
                    <el-table-column label="ËΩ¶Âú∫" prop="parkName"></el-table-column>
                    <el-table-column label="Âú∞ÂùÄ" prop="detailAddress"></el-table-column>
                    <el-table-column label="ÂÖ•Âú∫Êó∂Èó¥" prop="inTime"></el-table-column>
                    <el-table-column label="Êü•ËØ¢Êó∂Èó¥" prop="create_time"></el-table-column>
                    <el-table-column label="ÂÅúÁïôÊó∂Èó¥" prop="residenceTime"></el-table-column>
                    <el-table-column label="ÂØπÊé•/‰∏öÂä°" prop="applicant"></el-table-column>
                    <el-table-column label="Â§áÊ≥®" prop="company"></el-table-column>
                    <el-table-column label="ÊúàÁßüËΩ¶" prop="monthlyRent"></el-table-column>
                    <el-table-column label="Êù•Ê∫ê" prop="webName"></el-table-column>
                    <el-table-column label="Êìç‰Ωú" width="100" header-align="center">
                        <template slot-scope="scope">
                            <el-button size="large" :round="true" type="success" @click="handleCopy(scope.row)">Â§çÂà∂</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>

            <!-- Tab 4 - ÊÄªÊï∞ÊçÆ -->
            <el-tab-pane label="ÊÄªÊï∞ÊçÆ" name="plate">
                <!-- <h2>ËΩ¶ÁâåÂè∑Êü•ËØ¢</h2> -->
                <el-input 
                    v-model="searchPlateNum" 
                    placeholder="ËæìÂÖ•ËΩ¶ÁâåÂè∑Ê®°Á≥äÊêúÁ¥¢" 
                    @keyup.enter.native="searchPlate"
                    style="width: 300px; margin-bottom: 20px;"
                ></el-input>

                <el-button 
                    type="primary" 
                    :round="true"
                    @click="searchPlate" 
                    style="margin-left: 10px;"
                >ÊêúÁ¥¢</el-button>
                
                <el-table :data="searchPlatesResults" stripe style="width: 100%">
                    <el-table-column label="ËΩ¶ÁâåÂè∑" prop="plateNum"></el-table-column>
                    <el-table-column label="ËΩ¶Êû∂Âè∑" prop="frameNo"></el-table-column>
                    <el-table-column label="ÂèëÂä®Êú∫Âè∑" prop="engineNumber"></el-table-column>
                    <el-table-column label="Êä•Âçï‰∫∫" prop="applicant"></el-table-column>
                    <el-table-column label="ÂÖ¨Âè∏" prop="company"></el-table-column>
                    <el-table-column label="ËΩ¶Âûã" prop="carModel"></el-table-column>
                    <el-table-column label="ËΩ¶È¢úËâ≤" prop="color"></el-table-column>
                    <el-table-column label="‰Ω£Èáë" prop="commission"></el-table-column>
                    <el-table-column label="VIPËΩ¶Áâå" prop="vip"></el-table-column>
                    <el-table-column label="Âå∫Âüü" prop="area"></el-table-column>
                    <el-table-column label="Êìç‰Ωú" width="100" header-align="center">
                        <template slot-scope="scope">
                            <el-button size="large" :round="true" type="success" @click="copyText('plate',scope.row)">Â§çÂà∂</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>
        </el-tabs>
    </div>

    <!-- ÂºïÂÖ• Vue Âíå Element UI JS -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-ui/lib/index.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    activeTab: "fast", // ÈªòËÆ§ÊøÄÊ¥ªÁöÑ Tab
                    refreshInterval: 5000,
                    tableDataFast: [],
                    tableDataSlow: [],
                    refreshIntervalId: null,
                    singleClickTimeout: null,
                    searchPlateNum: '',  // Â≠òÂÇ®Áî®Êà∑ËæìÂÖ•ÁöÑËΩ¶ÁâåÂè∑
                    searchFullPlateNum: '',
                    searchPlatesResults: [],   // Â≠òÂÇ®ÊêúÁ¥¢ÁªìÊûú
                    searchFullPlatesResults: [],   // Â≠òÂÇ®ÊêúÁ¥¢recordsÁªìÊûú
                };
            },
            methods: {
                // Ëé∑ÂèñÂÅúËΩ¶ËÆ∞ÂΩï
                fetchData() {
                    fetch('/get_data?tab=fast')
                        .then(response => response.json())
                        .then(data => {
                            this.tableDataFast = data;
                        })
                        .catch(err => console.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•', err));
                    fetch('/get_data?tab=slow')
                        .then(response => response.json())
                        .then(data => {
                            this.tableDataSlow = data;
                        })
                        .catch(err => console.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•', err));
                },

                // Â§ÑÁêÜËá™Âä®Âà∑Êñ∞Èó¥ÈöîÁöÑÂèòÂåñ
                handleIntervalChange(value) {
                    clearInterval(this.refreshIntervalId);
                    if (value > 0) {
                        this.refreshIntervalId = setInterval(this.fetchData, value);
                    }
                },

                markAsRead(record) {
                // Âà§Êñ≠tabÊòØÂê¶‰∏∫'plate'
                    if (this.activeTab === 'plate') {
                        return;
                    }
                    if (this.activeTab === 'search_records') {
                        return;
                    }
                    record.state = "Â∑≤ËØª";
                    const url = `/mark_read?tab=${this.activeTab}`;
                    fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ row_num: record.row_num })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            this.fetchData();
                        }
                    })
                    .catch(err => console.error('Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•', err));
                },

                // Ê†áËÆ∞‰∏∫Êú™ËØª
                markAsUnread(record) {
                    record.state = "";
                    const url = `/mark_unread?tab=${this.activeTab}`;
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ row_num: record.row_num })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === "success") {
                                // this.$message.warning("ÊàêÂäüËÆæÁΩÆ‰∏∫Êú™ËØª");
                                this.fetchData();
                            }
                        })
                        .catch(err => console.error('Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•', err));
                },

                // ÂçïÂáª/ÂèåÂáªÂ§çÂà∂
                handleCopy(record) {
                    // ÊØèÊ¨°ÁÇπÂáªÈÉΩËß¶Âèë this.markAsRead
                    if (!this.singleClickTimeout) {
                        this.markAsRead(record);
                    }
                    if (this.singleClickTimeout) {
                        clearTimeout(this.singleClickTimeout);
                        this.singleClickTimeout = null;
                        this.copyText('double', record);
                    } else {
                        this.singleClickTimeout = setTimeout(() => {
                            this.copyText('single', record);
                            this.singleClickTimeout = null;
                        }, 300);
                    }
                },

                // Â§çÂà∂ÊñáÊú¨
                copyText(type, record) {
                    let text;
                    let toastMessage;
                    if (type === 'single') {
                        text = `ËΩ¶   Áâå: ${record.plateNum}\nËΩ¶   Êû∂: ${record.frameNo}\nËΩ¶   Âûã: ${record.carModel}\nËΩ¶Âú∫Âêç: ${record.parkName}\nËØ¶ÁªÜÂú∞ÂùÄ: ${record.detailAddress}\n*****-->: ${record.webName}\nÂÖ•Âú∫-->: ${record.inTime}\nÊü•ËØ¢-->: ${record.create_time}\nÂÅúÁïô-->: ${record.residenceTime}\nÁ±ªÂûã-->: ${record.monthlyRent === 'ÊòØ' ? 'ÊúàÁßüËΩ¶' : '‰∏¥Êó∂ËΩ¶'}\nÂ§áÊ≥®-->: ${record.company}\n‰∏öÂä°-->: ${record.applicant}`;
                        toastMessage = 'ÂçïÂáªÂ§çÂà∂ÊàêÂäü';
                    } else {
                        text = `ËΩ¶   Áâå: ${record.plateNum}\nËΩ¶   Êû∂: ${record.frameNo}\nËΩ¶   Âûã: ${record.carModel}\nÂèëÂä®Êú∫: ${record.engineNumber}\nÈ¢ú   Ëâ≤: ${record.color}\nÈáë   È¢ù: ${record.commission}\nÂå∫   Âüü: ${record.area}\nÂ§áÊ≥®-->: ${record.company}\nÂØπÊé•-->: ${record.applicant}`;
                        toastMessage = 'ÂèåÂáªÂ§çÂà∂ÊàêÂäü';
                    }

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text)
                            .then(() => {
                                // this.$message.success(toastMessage);
                                // this.markAsRead(record);
                            })
                            .catch(err => console.error('Â§çÂà∂Â§±Ë¥•', err));
                    } else {
                        this.fallbackCopyText(type, text, record);
                    }
                },

                // Â§çÂà∂Â§±Ë¥•Êó∂ÁöÑÂõûÈÄÄÊñπÊ°à
                fallbackCopyText(type, text, record) {
                    let textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        // this.$message.success(type === 'single' ? 'ÂçïÂáªÂ§çÂà∂ÊàêÂäü' : 'ÂèåÂáªÂ§çÂà∂ÊàêÂäü');
                        // this.markAsRead(record);
                    } catch (err) {
                        console.error('Â§çÂà∂Â§±Ë¥•', err);
                    }
                    document.body.removeChild(textarea);
                },
                // Ê®°Á≥äÊêúÁ¥¢ËΩ¶ÁâåÂè∑
                searchPlate() {
                    if (this.searchPlateNum.trim() === '') {
                        this.searchPlatesResults = [];  // Ê∏ÖÁ©∫ÁªìÊûú
                        return;
                    }

                    fetch(`/search_plate?plateNum=${this.searchPlateNum}`)
                        .then(response => response.json())
                        .then(data => {
                            this.searchPlatesResults = data;  // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
                        })
                        .catch(err => console.error('ÊêúÁ¥¢Â§±Ë¥•', err));
                },
                // Á≤æÁ°ÆÊêúÁ¥¢ËΩ¶ÁâåÂè∑
                searchRecords() {
                    if (this.searchFullPlateNum.trim() === '') {
                        this.searchFullPlatesResults = [];  // Ê∏ÖÁ©∫ÁªìÊûú
                        return;
                    }

                    fetch(`/search_records?plateNum=${this.searchFullPlateNum}`)
                        .then(response => response.json())
                        .then(data => {
                            this.searchFullPlatesResults = data;  // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
                        })
                        .catch(err => console.error('ÊêúÁ¥¢Â§±Ë¥•', err));
                }
            },
            mounted() {
                this.fetchData();
                if (this.refreshInterval > 0) {
                    this.refreshIntervalId = setInterval(this.fetchData, this.refreshInterval);
                }
            }
        });
    </script>
</body>
</html>

